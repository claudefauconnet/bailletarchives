<!DOCTYPE html>
<html>
<meta charset=utf-8>
<head>
    <meta name="description" content="D3.js v4, transition, color, location"/>
    <script src="js/jquery/jquery.min.js"></script>
    <script src="js/jquery/jquery-ui.min.js"></script>
    <script>
        $(function () {
            dialog = $("#dialogDiv").dialog({
                position: {my: "center center", at: "center center-200", of: window},
                autoOpen: false,
                height: "300px",
                width: "300px",
                modal: false,
                close: function () {
                    // allFields.removeClass("ui-state-error");
                }

            });
        })
    </script>
    <style>
        body {
            font-family: Verdana;
            font-size: 12px;
        }

        #dialogContentDiv {
            background-color: #CCCCCC;

        }

        #messageSpan {
            color: #003eff;
            font-weight: bold;
        }

    </style>
</head>

<body>
<script src="http://d3js.org/d3.v4.min.js"></script>

<script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
<script>
    var svg;
    var totalWidth;
    var totalHeight;
    var svgWidth;
    var svgHeight;
    var nBoitesTablette = 13;
    var oldNumVersement = "";
    var boiteColor = "";
    d3.json("./js/d3/magasin.json", function (data) {

        var nMag = data.children.length;

        totalWidth = $(window).width()-100
        totalHeight = $(window).height()-100;
        $("#graphDiv").width(totalWidth)
        $("#graphDiv").height(totalHeight)

        svgWidth = totalWidth
        svgHeight = totalHeight
        var zoom = d3.zoom().on("zoom", function () {svg.attr("transform", d3.event.transform)

        }).scaleExtent([.3, 2])

        svg = d3.select('#graphDiv')
            .append('svg')
            .attrs({width: svgWidth, height: svgHeight})
            .call(zoom)
            .append("g").attr("class", "viewport");
        var magW = totalWidth / 2;
        var magH = totalHeight*2;
        var magX = 150;
        var magY = 50;

        data.children.forEach(function (magasin) {
            //  console.log(magasin.name + "  " + magasin.children.length)
            if (magasin.name == "" || !magasin.name)
                return;
            d3.select("g").append("text")
                .attr("x", magX + (magW / 2))
                .attr("y", magY - 20)
                .attr("dy", ".35em")
                .style("font-size", "18px")
                .style("font-weight", "bold")
                .text(function (d) {
                    return magasin.name
                });
            d3.select("g").append('rect')
                .attrs({
                    x: magX,
                    y: magY,
                    width: magW,
                    height: magH,
                    fill: '#ddd',
                    stroke: "black",
                    "stroke-width": "3"
                });

            var epiYOffset = 10
            var epiW = magW;
            var epiH = (magH) / magasin.children.length;
            epiH = epiH - epiYOffset - 1
            var epiX = magX;
            var epiY = magY;

            magasin.children.forEach(function (epi, indexEpi) {
                d3.select("g").append("text")
                    .attr("x", epiX - 20)
                    .attr("y", epiY + (epiH / 2))
                    .attr("dy", ".35em")
                    .style("text-anchor", "end")
                    .text(function (d) {
                        return epi.name
                    });
                d3.select("g").append('rect')
                    .attrs({
                        x: epiX,
                        y: epiY,
                        width: epiW,
                        height: epiH,
                        fill: 'none',
                        stroke: "black",
                        "stroke-width": "3"
                    });
                var traveeW = epiW / epi.children.length;
                var traveeH = epiH;
                var traveeX = epiX;
                var traveeY = epiY;

                epi.children.forEach(function (travee, indexTravee) {


                    if (indexEpi == 0) {
                        d3.select("g").append("text")
                            .attr("x", traveeX + (traveeW / 2))
                            .attr("y", traveeY - 10)
                            .attr("dy", ".35em")
                            .style("text-anchor", "end")
                            .text(function (d) {
                                return indexTravee + 1
                            })
                    }
                    d3.select("g").append('rect')
                        .attrs({
                            x: traveeX,
                            y: traveeY,
                            width: traveeW,
                            height: traveeH,
                            fill: 'none',
                            stroke: "black",
                            "stroke-width": "1"
                        });
                    var tabW = traveeW
                    var tabH = traveeH / travee.children.length;
                    ;
                    var tabX = traveeX;
                    var tabY = traveeY;

                    travee.children.forEach(function (tab, indexTab) {
                        var tabletteCoordonnees = tab.name;
                        var nBoites = tab.children.length;
                        if (indexTravee == 0) {
                            d3.select("g").append("text")
                                .attr("x", tabX - 5)
                                .attr("y", tabY + (tabH / 2))
                                .attr("dy", ".35em")
                                .style("text-anchor", "end")
                                .style("font-size", "10px")
                                .text(function (d) {
                                    return indexTab + 1
                                })
                        }
                        var tablette = d3.select("g").append('rect')
                            .attrs({
                                x: tabX,
                                y: tabY,
                                width: tabW,
                                height: tabH,
                                fill: 'none',
                                stroke: "blue",
                                "stroke-width": "1"
                            });
                        var bteW = tabW / nBoitesTablette
                        var bteH = tabH - 1;
                        var bteX = tabX;
                        var bteY = tabY + 1;


                        function getRandomColor() {
                            var letters = '0123456789ABCDEF';
                            var color = '#';
                            for (var i = 0; i < 6; i++) {
                                color += letters[Math.floor(Math.random() * 16)];
                            }
                            return color;
                        }


                        tab.children.forEach(function (boite, boiteIndex) {

                            if (oldNumVersement != boite.numVersement) {
                                oldNumVersement = boite.numVersement
                                boiteColor = getRandomColor();
                            }


                            d3.select("g").append('rect')
                                .attrs({
                                    x: function (d) {
                                        return bteX
                                    },

                                    y: function (d) {
                                        return bteY
                                    },

                                    width: bteW,
                                    height: bteH,

                                    fill: function (d) {
                                        return boiteColor
                                    },
                                    numVersement: boite.numVersement,
                                    name: boite.name,
                                    coordonnees: tabletteCoordonnees,
                                    nBoites: nBoites,
                                    class: "boite",
                                    stroke: "none",
                                    "stroke-width": null
                                })
                                .on("click", function () {
                                    onBoitecCick(boite);


                                });
                            bteX += bteW

                        })
                        tabY += tabH

                    })
                    traveeX += traveeW


                })
                epiY += epiH + epiYOffset


            })

            //  magY += magH + 20;
            magX += magW + 100;
        })

        function onBoitecCick(boite) {

            var urlPrefix = "."
            var sql = "select * from versement where numVersement='" + boite.numVersement + "'"
            var payload = {
                exec: 1,
                sql: sql
            }

            $.ajax({
                type: "POST",
                url: urlPrefix + "/mysql",
                data: payload,
                dataType: "json",
                success: function (data) {
                    var obj = data[0];
                    var html = "<table>"
                    for (var key in obj) {
                        html += "<tr><td>" + key + "</td><td>" + obj[key] + "</td>"
                    }
                    html += "</table>"


                    $("#dialogDiv").dialog("open");
                    $("#dialogContentDiv").html(html);
                },
                error: function (err) {
                    console.log(err.responseText)

                }
            })

        }


    })

    function centerOnElt(elt) {
        var currentZoom = d3.zoomTransform(elt).k;
        var w = $(window).width() / 2;
        var h = $(window).height() / 2;
        var xx = w - d3.select(elt).attr("x") * currentZoom

        var yy = h - d3.select(elt).attr("y") * currentZoom
        d3.select(".viewport").attr("transform", "translate(" + (xx) + "," + (yy) + ") scale(" + 1 + ")")
        /*    d3.select(".viewport").transition()
                .duration(10)

                .attr("transform", "translate(" + (xx) + "," + ( yy) + ")")//scale(" + 1 + ")")*/
        // .on("end", function(){ svg.call(zoom.transform, d3.zoomIdentity.translate((totalWidth/2 - xx),(totalHeight/2 - yy)).scale(1))});
    }

    function searchVersement(versement) {
        versement = prompt("numero de versement")
        var found = 0;
        var firstBoiteName = ""
        var coordonnees = "";
        if (versement && versement != "") {

            d3.selectAll(".boite").each(function (d, i) {
                d3.select(this).style("opacity", 0.1)
                var x = d;
                var numVersement = d3.select(this).attr("numVersement");

                var firstbox = true;
                if (versement == numVersement) {
                    found += 1
                    if (firstbox) {
                        firstBoiteName = d3.select(this).attr("name");
                        coordonnees = d3.select(this).attr("coordonnees");


                        $("#messageSpan").html(message)
                        firstbox = false
                        centerOnElt(this)

                    }
                    d3.select(this).style("opacity", 1)


                }

            })
            if (found > 0) {
                var message = "localisation : " + coordonnees + " nombre de boites +" + found + "+ première boite " + firstBoiteName;
                $("#messageSpan").html(message);
            }
            else
                $("#messageSpan").html("aucune boite correspond au versement " + versement)
        }
    }
    clearVersement=function(){
        $("#messageSpan").html("");
        d3.selectAll(".boite").style("opacity", 1)
    }


</script>
</body>
<div>
    <button onclick="searchVersement('0114')">Chercher versement</button>
    <button onclick="clearVersement()">Annuler</button>
    <span id="messageSpan"></span>
</div>
<div id="graphDiv"></div>
<div id="dialogDiv">
    <div id="dialogContentDiv"></div>
</div>
</html>