<!DOCTYPE html>
<html>
<meta charset=utf-8>
<head>
    <meta name="description" content="D3.js v4, transition, color, location"/>
    <script src="js/jquery/jquery.min.js"></script>
    <script src="js/jquery/jquery-ui.min.js"></script>

    <script src="js/mainController.js"></script>
    <script>

        var dialogD3;
        $(function () {
            magasinD3.drawMagasins()

            dialogD3 = $("#dialogD3").dialog({
                autoOpen: false,
                modal: false,
                position: { my: "center top", at: "center top", of: window },
                close: function () {
                    // allFields.removeClass("ui-state-error");
                }
            });
        })


        var magasinD3 = (function () {
            var self = {};
            self.currentVersement = {}

            var urlPrefix = "."
            var magasinData;
            var svg;
            var totalWidth;
            var totalHeight;
            var svgWidth;
            var svgHeight;
            var nBoitesTablette = 13;
            var oldNumVersement = "";
            var boiteColor = "";

            self.drawMagasins = function () {
                //d3.json("./js/d3/magasin.json", function (data) {
                d3.select("svg").remove();
                $("#graphDiv").html("");
                d3.json(urlPrefix + "/magasinD3Tree", function (data) {
                    var nMag = data.children.length;
                    magasinData = data;
                    totalWidth = $(window).width() - 150
                    totalHeight = $(window).height() - 150;
                    $("#graphDiv").width(totalWidth)
                    $("#graphDiv").height(totalHeight)

                    svgWidth = totalWidth
                    svgHeight = totalHeight
                    var zoom = d3.zoom().on("zoom", function () {
                        svg.attr("transform", d3.event.transform)

                    }).scaleExtent([.3, 2])

                    svg = d3.select('#graphDiv')
                        .append('svg')
                        .attrs({width: svgWidth, height: svgHeight})
                        .call(zoom)
                        .append("g").attr("class", "viewport");
                    var magW = totalWidth / 2;
                    var magH = totalHeight * 2;
                    var magX = 150;
                    var magY = 50;

                    data.children.forEach(function (magasin) {
                        //  console.log(magasin.name + "  " + magasin.children.length)
                        if (magasin.name == "" || !magasin.name)
                            return;
                        d3.select("g").append("text")
                            .attr("x", magX + (magW / 2))
                            .attr("y", magY - 20)
                            .attr("dy", ".35em")
                            .style("font-size", "18px")
                            .style("font-weight", "bold")
                            .text(function (d) {
                                return magasin.name
                            });
                        d3.select("g").append('rect')
                            .attrs({
                                x: magX,
                                y: magY,
                                width: magW,
                                height: magH,
                                fill: '#ddd',
                                stroke: "black",
                                "stroke-width": "3"
                            }).on("click", function () {
                            $("#popupD3Div").css("visibility", "hidden")
                        });
                        ;

                        var epiYOffset = 10
                        var epiW = magW;
                        var epiH = (magH) / magasin.children.length;
                        epiH = epiH - epiYOffset - 1
                        var epiX = magX;
                        var epiY = magY;

                        magasin.children.forEach(function (epi, indexEpi) {
                            d3.select("g").append("text")
                                .attr("x", epiX - 20)
                                .attr("y", epiY + (epiH / 2))
                                .attr("dy", ".35em")
                                .style("text-anchor", "end")
                                .text(function (d) {
                                    return epi.name
                                })

                            d3.select("g").append('rect')
                                .attrs({
                                    x: epiX,
                                    y: epiY,
                                    width: epiW,
                                    height: epiH,
                                    fill: 'none',
                                    stroke: "black",
                                    "stroke-width": "3"
                                });
                            var traveeW = epiW / epi.children.length;
                            var traveeH = epiH;
                            var traveeX = epiX;
                            var traveeY = epiY;

                            epi.children.forEach(function (travee, indexTravee) {


                                if (indexEpi == 0) {
                                    d3.select("g").append("text")
                                        .attr("x", traveeX + (traveeW / 2))
                                        .attr("y", traveeY - 10)
                                        .attr("dy", ".35em")
                                        .style("text-anchor", "end")
                                        .text(function (d) {
                                            return indexTravee + 1
                                        })
                                }
                                d3.select("g").append('rect')
                                    .attrs({
                                        x: traveeX,
                                        y: traveeY,
                                        width: traveeW,
                                        height: traveeH,
                                        fill: 'none',
                                        stroke: "black",
                                        "stroke-width": "1"
                                    });
                                var tabW = traveeW
                                var tabH = traveeH / travee.children.length;
                                ;
                                var tabX = traveeX;
                                var tabY = traveeY;

                                travee.children.forEach(function (tab, indexTab) {
                                    var tabletteCoordonnees = tab.name;
                                    var nBoites = tab.children.length;
                                    if (indexTravee == 0) {
                                        d3.select("g").append("text")
                                            .attr("x", tabX - 5)
                                            .attr("y", tabY + (tabH / 2))
                                            .attr("dy", ".35em")
                                            .style("text-anchor", "end")
                                            .style("font-size", "10px")
                                            .text(function (d) {
                                                return indexTab + 1
                                            })
                                    }
                                    var tablette = d3.select("g").append('rect')
                                        .attrs({
                                            x: tabX,
                                            y: tabY,
                                            width: tabW,
                                            height: tabH,
                                            name: tab.name,
                                            class: "tablette",
                                            fill: 'none',
                                            stroke: "blue",
                                            "stroke-width": "1"
                                        });
                                    var bteW = tabW / nBoitesTablette
                                    var bteH = tabH - 1;
                                    var bteX = tabX;
                                    var bteY = tabY + 1;


                                    function getRandomColor() {
                                        var letters = '0123456789ABCDEF';
                                        var color = '#';
                                        for (var i = 0; i < 6; i++) {
                                            color += letters[Math.floor(Math.random() * 16)];
                                        }
                                        return color;
                                    }


                                    tab.children.forEach(function (boite, boiteIndex) {

                                        if (oldNumVersement != boite.numVersement) {
                                            oldNumVersement = boite.numVersement
                                            boiteColor = getRandomColor();
                                        }


                                        d3.select("g").append('rect')
                                            .attrs({
                                                x: function (d) {
                                                    return bteX
                                                },

                                                y: function (d) {
                                                    return bteY
                                                },

                                                width: bteW,
                                                height: bteH,

                                                fill: function (d) {
                                                    return boiteColor
                                                },
                                                numVersement: boite.numVersement,
                                                name: boite.name,
                                                coordonnees: tabletteCoordonnees,
                                                nBoites: nBoites,
                                                class: "boite",
                                                stroke: "black",
                                                "stroke-width": 1
                                            })
                                            .on("click", function () {
                                                var position = d3.mouse(this);
                                                onBoiteClick(boite, position[0], position[1]);
                                                return false;


                                            });
                                        bteX += bteW

                                    })
                                    tabY += tabH

                                })
                                traveeX += traveeW


                            })
                            epiY += epiH + epiYOffset


                        })

                        //  magY += magH + 20;
                        magX += magW + 100;
                    })

                    function onBoiteClick(boite, x, y) {

                        var urlPrefix = "."
                        var sql = "select * from versement where numVersement='" + boite.numVersement + "'"
                        var payload = {
                            exec: 1,
                            sql: sql
                        }

                        $.ajax({
                            type: "POST",
                            url: urlPrefix + "/mysql",
                            data: payload,
                            dataType: "json",
                            success: function (data) {
                                var obj = data[0];
                                var html = "<table>"
                                var keys = ["numVersement", "cotesExtremeBoites", "nbBoites", "metrage", "theme"];
                                for (var key in obj) {
                                    if (keys.indexOf(key) > -1)
                                        html += "<tr><td>" + key + "</td><td>" + obj[key] + "</td>"
                                }
                                html += "</table>"
                                $("#popupD3Div").html(html);
                                $("#popupD3Div").css("top", y - 20);
                                $("#popupD3Div").css("left", x + 20)
                                $("#popupD3Div").css("visibility", "visible")
                                /*  $("#popupD3Div").dialog("open");
                              $("#dialogContentDiv").html(html);*/
                            },
                            error: function (err) {
                                console.log(err.responseText)

                            }
                        })

                    }


                })
            }

            self.centerOnElt = function (elt) {
                var currentZoom = d3.zoomTransform(elt).k;
                var w = $(window).width() / 2;
                var h = $(window).height() / 2;
                var xx = w - d3.select(elt).attr("x") * currentZoom

                var yy = h - d3.select(elt).attr("y") * currentZoom
                d3.select(".viewport").attr("transform", "translate(" + (xx) + "," + (yy) + ") scale(" + 1 + ")")
                /*    d3.select(".viewport").transition()
                        .duration(10)

                        .attr("transform", "translate(" + (xx) + "," + ( yy) + ")")//scale(" + 1 + ")")*/
                // .on("end", function(){ svg.call(zoom.transform, d3.zoomIdentity.translate((totalWidth/2 - xx),(totalHeight/2 - yy)).scale(1))});
            }

            self.searchVersement = function (versement) {
                versement = prompt("numero de versement")
                var found = 0;
                var firstBoiteName = ""
                var coordonnees = "";
                if (versement && versement != "") {
                    $("#popupD3Div").css("visibility", "hidden")
                    d3.selectAll(".boite").each(function (d, i) {
                        d3.select(this).style("opacity", 0.1)
                        var x = d;
                        var numVersement = d3.select(this).attr("numVersement");

                        var firstbox = true;
                        if (versement == numVersement) {
                            found += 1
                            if (firstbox) {
                                firstBoiteName = d3.select(this).attr("name");
                                coordonnees = d3.select(this).attr("coordonnees");


                                $("#messageSpan").html(message)
                                firstbox = false
                                self.centerOnElt(this)

                            }
                            d3.select(this).style("opacity", 1)
                            d3.select(this).style("stroke", "red")


                        }

                    })
                    if (found > 0) {
                        var message = "versement " + versement + " , localisation : " + coordonnees + " nombre de boites +" + found + "+ première boite " + firstBoiteName;
                        $("#messageSpan").html(message);
                    }
                    else
                        $("#messageSpan").html("aucune boite correspond au versement " + versement)
                }
            }

            self.clearHighlights = function () {
                $("#popupD3Div").css("visibility", "hidden")
                d3.selectAll(".boite").style("opacity", 1)
                d3.selectAll(".tablette").style("fill", "none").style(" stroke", "blue");
            }

            self.showDialogChercherTablettesPourVersement = function () {

                $("#dialogD3").attr("title", "chercher des tablettes");
                dialogD3.dialog("open")
                $("#dialogD3").load("./htmlSnippets/" + "findTablettesDialogD3.html"), function () {

                }
            }

            self.chercherTablettesPourVersement = function (obj) {
                $("#findTablettes_message").html("");

                //  var metrage = prompt("longueur du versement")
                if (!obj.metrage || obj.metrage == null)
                    return;
                //obj.metrage = parseFloat(obj.metrage.replace(",", "."));
                var longueurCumulee = 0;
                var tablettesOK = [];
                var done = false;
                magasinData.children.forEach(function (magasin) {
                    if (!done)
                        magasin.children.forEach(function (epi) {
                            if (!done)
                                epi.children.forEach(function (travee) {
                                    if (!done)
                                        travee.children.forEach(function (tablette) {
                                            if (!done)
                                                if ((!tablette.numVersement || tablette.numVersement == 0) && tablette.children.length == 0) {// tablette vide
                                                    if (tablettesOK.length > 0 && !self.areTablettesContigues(tablettesOK[tablettesOK.length - 1], tablette.name)) {
                                                        tablettesOK = []// on recommence si tablettes pas contigues
                                                        longueurCumulee = 0;
                                                    }
                                                    longueurCumulee += tablette.longueurM;
                                                    tablettesOK.push(tablette.name)
                                                    if (longueurCumulee >= obj.metrage)
                                                        done = true;
                                                }
                                                else {
                                                    tablettesOK = []// on recommence si uen tablette est occuppée
                                                    longueurCumulee = 0;
                                                }


                                        })
                                })
                        })

                })

                var xx = tablettesOK;
                self.currentVersement = obj;
                self.currentVersement.tablettes = tablettesOK
                $("#findTablettes_message").html("Tablettes contigues libres pour " + obj.metrage + " m : de " + tablettesOK[0] + " à " + tablettesOK[tablettesOK.length - 1])
                $("#findTablettesD3_versementBoitesToTablettesButton").removeAttr("disabled")
                var first = true;
                d3.selectAll(".boite").style("opacity", 0.3)
                d3.selectAll(".tablette").style("fill", "none").style(" stroke", "blue");
                d3.selectAll(".tablette").each(function (d, i) {


                    var name = d3.select(this).attr("name");
                    if (tablettesOK.indexOf(name) > -1) {

                        d3.select(this).style("opacity", 1).style("stroke", "black").style("fill", "green")
                        if (first == true) {
                            self.centerOnElt(this)
                            first = false;
                        }


                    }

                })


            }

            self.areTablettesContigues = function (a, b) {

                arrayA = a.split("-");
                arrayB = b.split("-");
                if (arrayA.length != 4 || arrayB.length != 4)
                    return null;
                for (var i = 1; i < 4; i++) {
                    arrayA[i] = parseInt(arrayA[i])
                    arrayB[i] = parseInt(arrayB[i])
                }

                if (arrayB[3] - arrayA[3] == 1)//mema travee
                    return true;
                else {// changement de travee
                    if (arrayB[2] - arrayA[2] == 1)
                        return true;
                    else {
                        if ((arrayB[1] - arrayA[1]) == 1 && (arrayB[2] - arrayA[2]) > 0)//changement d'épi
                            return true;
                        else
                            return false;
                    }
                }


            }

            return self;
        })()


    </script>
    <style>
        body {
            font-family: Verdana;
            font-size: 12px;
        }

        #popupD3Div {
            visibility: hidden;
            position: absolute;
            background-color: #ddd;
            margin: 3px;
            padding: 3px;
            border-style: solid;
            border-width: 1px;
        }

        #dialogContentDiv {

        }

        #dialogD3 {
            background-color: #ddd;
            margin: 3px;
            padding: 3px;
            width: 500px;
            height: 500px;
        }

        #messageSpan {
            color: #003eff;
            font-weight: bold;
        }

    </style>
</head>

<body>
<script src="js/d3/d3.js"></script>
<script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>


</body>
<div>
    <button onclick="magasinD3.searchVersement('0114')">Chercher versement</button>
    <button onclick="magasinD3.showDialogChercherTablettesPourVersement()">Chercher tablettes libre</button>
    <button onclick="magasinD3.clearHighlights()">Annuler</button>

    <span id="messageSpan"></span>
</div>
<div id="graphDiv"></div>
<div id="popupD3Div">
    <div id="dialogContentDiv"></div>
</div>

<div id="dialogD3">

</div>
</html>